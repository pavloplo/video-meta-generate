name: Deploy (staging)

on:
  push:
    branches: ["dev", "main"]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch/tag) to deploy"
        required: true
        default: "dev"

permissions:
  contents: read

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  build-and-deploy:
    environment: staging
    runs-on: self-hosted
    # To use a specific host, configure the 'staging' environment in GitHub
    # Settings → Environments → staging → Add deployment branch rule
    # Then add runner labels like: runs-on: [self-hosted, staging]

    env:
      APP_DIR: /srv/apps/video-meta-generate
      NODE_ENV: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.STAGING_DIRECT_URL }}
        run: npm run db:generate

      - name: Build application
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.STAGING_DIRECT_URL }}
          NODE_ENV: production
        run: npm run build

      - name: Create deployment package
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.STAGING_DIRECT_URL }}
        run: |
          DEPLOY_DIR="${APP_DIR}/deploy-$(date +%s)"
          mkdir -p "${DEPLOY_DIR}/logs"
          
          cp -r .next node_modules prisma src scripts "${DEPLOY_DIR}/"
          cp package.json package-lock.json prisma.config.ts next.config.js tsconfig.json "${DEPLOY_DIR}/"
          cp ecosystem.config.js "${DEPLOY_DIR}/" 2>/dev/null || true
          
          node -e "const fs=require('fs');fs.writeFileSync('${DEPLOY_DIR}/.env',\`DATABASE_URL=\${process.env.DATABASE_URL}\\nDIRECT_URL=\${process.env.DIRECT_URL}\\nNODE_ENV=production\\n\`);"
          
          ln -sfn "${DEPLOY_DIR}" "${APP_DIR}/current"
          echo "DEPLOY_DIR=${DEPLOY_DIR}" >> $GITHUB_ENV

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          DIRECT_URL: ${{ secrets.STAGING_DIRECT_URL }}
        run: |
          cd "${APP_DIR}/current"
          npm run db:deploy

      - name: Restart application
        run: |
          export PM2_APP_NAME=video-meta-generate
          export PM2_APP_DIR="${APP_DIR}/current"
          cd "$PM2_APP_DIR"
          /usr/local/bin/pm2 delete video-meta-generate || true
          /usr/local/bin/pm2 start ecosystem.config.js --update-env
          /usr/local/bin/pm2 save
          /usr/local/bin/pm2 status

      - name: Cleanup old deployments
        run: |
          cd "${APP_DIR}"
          ls -dt deploy-* 2>/dev/null | tail -n +6 | xargs rm -rf || true
