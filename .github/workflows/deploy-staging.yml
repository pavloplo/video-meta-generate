name: Deploy (staging)

on:
  push:
    branches: ["dev", "main"]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch/tag) to deploy"
        required: true
        default: "dev"
      

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  build-and-deploy:
    environment: staging
    runs-on: self-hosted

    env:
      APP_DIR: /srv/apps/video-meta-generate
      IMAGE: ghcr.io/${{ github.repository_owner }}/video-meta-generate:dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}
          fetch-depth: 1
      - name: Debug deploy variables
        env:
          IMAGE: ${{ env.IMAGE }}
          APP_DIR: ${{ env.APP_DIR }}
        run: |
          set -e
          check_var() {
            local name="$1"
            local value="$2"
            if [ -n "$value" ]; then
              echo "$name: set (length ${#value})"
            else
              echo "$name: missing"
            fi
          }
          check_var "IMAGE" "$IMAGE"
          check_var "APP_DIR" "$APP_DIR"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set database URLs
        run: |
          # Set database URLs from GitHub secrets
          echo "DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}" >> $GITHUB_ENV
          echo "DIRECT_URL=${{ secrets.STAGING_DIRECT_URL }}" >> $GITHUB_ENV

      - name: Build & push image (staging tag)
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ env.IMAGE }}
          build-args: |
            DATABASE_URL=${{ env.DATABASE_URL }}
            DIRECT_URL=${{ env.DIRECT_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Copy docker-compose.yml to deployment directory
        run: |
          set -e
          mkdir -p "${APP_DIR}"
          cp docker-compose.yml "${APP_DIR}/"
          chown -R $USER:$USER "${APP_DIR}"

      - name: Deploy on runner host
        run: |
          set -e
          cd "${APP_DIR}"
          export IMAGE="${{ env.IMAGE }}"
          export DATABASE_URL="${{ env.DATABASE_URL }}"
          export DIRECT_URL="${{ env.DIRECT_URL }}"
          echo "Pulling latest images..."
          docker compose pull
          echo "Running database migrations..."
          echo "DATABASE_URL is set: $(if [ -n \"${{ env.DATABASE_URL }}\" ]; then echo 'YES'; else echo 'NO'; fi)"
          echo "DIRECT_URL is set: $(if [ -n \"${{ env.DIRECT_URL }}\" ]; then echo 'YES'; else echo 'NO'; fi)"
          docker compose run --rm -e DATABASE_URL="${{ env.DATABASE_URL }}" -e DIRECT_URL="${{ env.DIRECT_URL }}" app sh -c "cd /app && echo 'Creating .env file for Prisma...' && echo 'DATABASE_URL='\$DATABASE_URL > .env && echo 'DIRECT_URL='\$DIRECT_URL >> .env && echo 'Verifying .env file...' && cat .env | sed 's/:\/\/.*@/:\/\/***:***@/' && echo 'Verifying environment variables...' && echo 'DIRECT_URL:' \${DIRECT_URL:+SET} && echo 'DATABASE_URL:' \${DATABASE_URL:+SET} && echo 'Running Prisma migrate deploy with explicit env vars...' && DIRECT_URL=\$DIRECT_URL DATABASE_URL=\$DATABASE_URL npm run db:deploy"
          echo "Starting application..."
          docker compose up -d app
          echo "Cleaning up unused images..."
          docker image prune -f
