name: Deploy (staging)

on:
  push:
    branches: ["dev", "main"]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch/tag) to deploy"
        required: true
        default: "dev"

permissions:
  contents: read

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  build-and-deploy:
    environment: staging
    runs-on: self-hosted

    env:
      APP_DIR: /srv/apps/video-meta-generate
      NODE_ENV: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Set database URLs
        run: |
          # Use multiline syntax to handle special characters (#, @, ?, =) in connection strings
          echo "DATABASE_URL<<EOF" >> $GITHUB_ENV
          echo "${{ secrets.STAGING_DATABASE_URL }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "DIRECT_URL<<EOF" >> $GITHUB_ENV
          echo "${{ secrets.STAGING_DIRECT_URL }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          DIRECT_URL: ${{ env.DIRECT_URL }}
        run: npm run db:generate

      - name: Build application
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          DIRECT_URL: ${{ env.DIRECT_URL }}
          NODE_ENV: production
        run: npm run build

      - name: Create deployment package
        run: |
          set -e
          DEPLOY_DIR="${APP_DIR}/deploy-$(date +%s)"
          mkdir -p "${DEPLOY_DIR}"
          
          # Copy necessary files
          cp -r .next "${DEPLOY_DIR}/"
          cp -r node_modules "${DEPLOY_DIR}/"
          cp -r prisma "${DEPLOY_DIR}/"
          cp -r src "${DEPLOY_DIR}/"
          cp -r scripts "${DEPLOY_DIR}/"
          cp package.json "${DEPLOY_DIR}/"
          cp package-lock.json "${DEPLOY_DIR}/"
          cp next.config.js "${DEPLOY_DIR}/"
          cp tsconfig.json "${DEPLOY_DIR}/"
          cp ecosystem.config.js "${DEPLOY_DIR}/" 2>/dev/null || true
          
          # Create .env file for runtime
          echo "DATABASE_URL=${DATABASE_URL}" > "${DEPLOY_DIR}/.env"
          echo "DIRECT_URL=${DIRECT_URL}" >> "${DEPLOY_DIR}/.env"
          echo "NODE_ENV=production" >> "${DEPLOY_DIR}/.env"
          
          # Create symlink for quick rollback
          ln -sfn "${DEPLOY_DIR}" "${APP_DIR}/current"
          
          echo "DEPLOY_DIR=${DEPLOY_DIR}" >> $GITHUB_ENV

      - name: Run database migrations
        run: |
          set -e
          cd "${APP_DIR}/current"
          export DATABASE_URL="${{ env.DATABASE_URL }}"
          export DIRECT_URL="${{ env.DIRECT_URL }}"
          npm run db:deploy

      - name: Restart application with PM2
        run: |
          set -e
          cd "${APP_DIR}/current"
          
          # Check if PM2 is installed
          if ! command -v pm2 &> /dev/null; then
            echo "Installing PM2..."
            npm install -g pm2
          fi
          
          # Stop existing process if running
          pm2 stop video-meta-generate || true
          pm2 delete video-meta-generate || true
          
          # Start new process
          if [ -f ecosystem.config.js ]; then
            pm2 start ecosystem.config.js
          else
            pm2 start npm --name video-meta-generate -- start
          fi
          
          # Save PM2 process list
          pm2 save
          
          # Show status
          pm2 status

      - name: Cleanup old deployments
        run: |
          set -e
          # Keep last 5 deployments
          cd "${APP_DIR}"
          ls -dt deploy-* 2>/dev/null | tail -n +6 | xargs rm -rf || true
          echo "Cleanup completed"
