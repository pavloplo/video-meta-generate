name: Deploy (staging)

on:
  push:
    branches: ["dev", "main"]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch/tag) to deploy"
        required: true
        default: "dev"
      

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  build-and-deploy:
    environment: staging
    runs-on: self-hosted

    env:
      APP_DIR: /srv/apps/video-meta-generate
      IMAGE: ghcr.io/${{ github.repository_owner }}/video-meta-generate:dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}
      - name: Debug deploy variables
        env:
          IMAGE: ${{ env.IMAGE }}
          APP_DIR: ${{ env.APP_DIR }}
        run: |
          set -e
          check_var() {
            local name="$1"
            local value="$2"
            if [ -n "$value" ]; then
              echo "$name: set (length ${#value})"
            else
              echo "$name: missing"
            fi
          }
          check_var "IMAGE" "$IMAGE"
          check_var "APP_DIR" "$APP_DIR"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set database URLs
        run: |
          # Set database URLs from GitHub secrets
          echo "DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}" >> $GITHUB_ENV
          echo "DIRECT_URL=${{ secrets.STAGING_DIRECT_URL }}" >> $GITHUB_ENV

      - name: Build & push image (staging tag)
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ env.IMAGE }}
          build-args: |
            DATABASE_URL=${{ env.DATABASE_URL }}
            DIRECT_URL=${{ env.DIRECT_URL }}

      - name: Copy docker-compose.yml to deployment directory
        run: |
          set -e
          sudo mkdir -p "${APP_DIR}"
          sudo cp docker-compose.yml "${APP_DIR}/"
          sudo chown -R $USER:$USER "${APP_DIR}"

      - name: Deploy on runner host
        run: |
          set -e
          cd "${APP_DIR}"
          export IMAGE="${{ env.IMAGE }}"
          export DATABASE_URL="${{ env.DATABASE_URL }}"
          export DIRECT_URL="${{ env.DIRECT_URL }}"
          docker compose pull
          echo "Running database migrations..."
          echo "DATABASE_URL is set: $(if [ -n \"${{ env.DATABASE_URL }}\" ]; then echo 'YES'; else echo 'NO'; fi)"
          echo "DIRECT_URL is set: $(if [ -n \"${{ env.DIRECT_URL }}\" ]; then echo 'YES'; else echo 'NO'; fi)"
          docker compose run --rm -e DATABASE_URL="${{ env.DATABASE_URL }}" -e DIRECT_URL="${{ env.DIRECT_URL }}" app sh -c "echo 'Container DATABASE_URL is set: '$(if [ -n \"\$DATABASE_URL\" ]; then echo 'YES'; else echo 'NO'; fi) && echo 'Container DIRECT_URL is set: '$(if [ -n \"\$DIRECT_URL\" ]; then echo 'YES'; else echo 'NO'; fi) && npm run db:deploy"
          docker compose up -d app
          docker image prune -f
